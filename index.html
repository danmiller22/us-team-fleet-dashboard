<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet</title>
<style>
:root{
  --bg:#000;--fg:#e8eaef;--muted:#9aa0a6;--ring:#151820;--tile:#0a0d12;--tile2:#0f131a;--accent:#ff3b30;
  --glass:rgba(255,255,255,.04);--glass2:rgba(255,255,255,.02)
}
*{box-sizing:border-box}html,body{height:100%}
body{
  margin:0;min-height:100vh;color:var(--fg);
  background:
    radial-gradient(1200px 600px at 50% -220px,#0e1322 0%,transparent 60%),
    linear-gradient(#000,#000);
  font:14px/1.5 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto
}
.wrap{padding:24px clamp(16px,4vw,48px)}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.brand{font-weight:600;font-size:18px;letter-spacing:.2px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.seg{display:flex;gap:6px;padding:4px;border:1px solid var(--ring);border-radius:12px;background:var(--tile);backdrop-filter:saturate(120%) blur(6px)}
.seg button{border:0;background:transparent;color:var(--muted);padding:6px 12px;border-radius:999px;font-weight:600;cursor:pointer;transition:all .25s}
.seg button.active{background:var(--tile2);color:#fff;box-shadow:0 0 0 1px #20242e inset}
input,button{appearance:none;border:1px solid var(--ring);background:var(--tile);color:#e8ebf1;border-radius:12px;padding:9px 12px;font-weight:600;outline:none;transition:all .25s}
button.accent{border-color:#3a1614;background:#17090a;color:#ffcdc9}
button:hover{filter:brightness(1.08)}
.pill{font-size:12px;color:var(--muted)}
.grid{display:grid;gap:14px}
.kpis{grid-template-columns:repeat(3,minmax(0,1fr))}
@media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.kpis{grid-template-columns:1fr}}
.card{
  position:relative;overflow:hidden;padding:14px;border-radius:18px;border:1px solid var(--ring);
  background:
    linear-gradient(180deg,var(--glass),var(--glass2)),
    radial-gradient(220px 120px at 20% -60px,rgba(255,255,255,.06),transparent 70%),
    linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));
  backdrop-filter:saturate(140%) blur(8px);
  box-shadow:0 6px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03)
}
.card::after{
  content:"";position:absolute;inset:-40% -40% auto auto;height:140%;width:140%;
  background:radial-gradient(800px 240px at 110% -20%,rgba(255,59,48,.08),transparent 60%);
  transform:translateZ(0)
}
.kv{font-size:28px;font-weight:600;margin-top:8px;letter-spacing:.2px;filter:drop-shadow(0 4px 14px rgba(255,59,48,.06))}
svg{width:100%;height:280px;border-radius:18px;background:linear-gradient(180deg,#0b0f15,#000);border:1px solid var(--ring)}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th,td{text-align:left;padding:12px 14px}th{font-size:12px;color:var(--muted)}
tr{
  background:linear-gradient(180deg,#0c1016,#0a0d12);
  border:1px solid var(--ring);border-radius:14px;overflow:hidden;transition:transform .18s, box-shadow .18s
}
tr:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.35)}
td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
.right{text-align:right}
.err{background:#160808;border:1px solid #3a1614;color:#ffcdc9;border-radius:12px;padding:10px 12px;margin:10px 0;white-space:pre-wrap;display:none}
.fadein{animation:fade .5s ease-out both} @keyframes fade{from{opacity:.0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head><body>
<div class="wrap">
  <header>
    <div class="brand">US Team Fleet</div>
    <div class="controls">
      <div class="seg" id="rangeSeg"><button data-range="7">7d</button><button data-range="30" class="active">30d</button></div>
      <input id="q" placeholder="Filter: amount, date, asset, repair"/>
      <button id="refresh" class="accent">Refresh</button>
      <span class="pill" id="status">boot…</span>
    </div>
  </header>

  <section class="grid kpis">
    <div class="card fadein"><div class="pill">Entries</div><div id="kpi-total" class="kv">—</div></div>
    <div class="card fadein" style="animation-delay:.05s"><div class="pill">Spend this month</div><div id="kpi-month" class="kv">—</div></div>
    <div class="card fadein" style="animation-delay:.1s"><div class="pill">Spend last 7 days</div><div id="kpi-week" class="kv">—</div></div>
  </section>

  <section class="grid" style="margin-top:14px">
    <div class="card fadein" style="padding:10px"><svg id="chart" viewBox="0 0 1000 280" preserveAspectRatio="none"></svg></div>
    <div class="card fadein" style="animation-delay:.05s">
      <div class="pill" style="margin-bottom:8px">Latest entries</div>
      <div id="error" class="err"></div>
      <div style="overflow:auto">
        <table id="tbl"><thead><tr>
          <th>Date</th><th>Asset</th><th>Repair</th><th class="right">Total</th><th>PaidBy</th><th>ReportedBy</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</div>

<script>
"use strict";
// CONFIG
var SHEET_ID="1yJIieOP9u4LAj1tizjOKtzGoHcTQwTVslj5fQ3nGMKA";
var GID="2027199769";
var CSV_URL="https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/export?format=csv&gid="+GID;
var WATCH_MS=20000;

// STATE
var lastSig=null, all=[], rows=[];

// UTILS
function $(s){return document.querySelector(s);}
function setStatus(t){var el=$("#status"); if(el) el.textContent=t;}
function money(n){return isNaN(n)?"—":Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});}
function nk(k){return String(k||"").toLowerCase().replace(/[\uFEFF\s_-]+/g,"").replace(/[^a-z0-9]/g,"");}
function toDate(s){if(!s)return null;var t=String(s).replace(/\uFEFF/g,"").trim(),m;
  m=/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/.exec(t);if(m)return new Date((+m[3]<100?2000+ +m[3]:+m[3]),+m[1]-1,+m[2]);
  m=/(\d{4})-(\d{2})-(\d{2})/.exec(t);if(m)return new Date(+m[1],+m[2]-1,+m[3]);var d=new Date(t);return isNaN(d)?null:d;}
function numUSD(s){if(s==null)return 0;var m=String(s).replace(/,/g,"").match(/-?\d+(\.\d+)?/);return m?Number(m[0]):0;}
function hash(s){var h=0;for(var i=0;i<s.length;i++)h=((h<<5)-h+s.charCodeAt(i))|0;return(h>>>0).toString(16);}

// Parser (quotes, commas)
function parseCSV(txt){
  var out=[],row=[],val="",i=0,q=false;
  function push(){row.push(val);val="";} function end(){out.push(row);row=[];}
  for(i=0;i<txt.length;i++){var c=txt[i];
    if(q){ if(c=='"'&&txt[i+1]=='"'){val+='"';i++;} else if(c=='"'){q=false;} else {val+=c;} }
    else{ if(c=='"'){q=true;} else if(c==','){push();} else if(c=='\n'){push();end();} else if(c=='\r'){} else {val+=c;} }
  } push(); if(row.length) end();
  if(!out.length) return [];
  var head=out[0].map(function(h){return nk(h);});
  var rows=out.slice(1).filter(function(r){return r.some(function(x){return String(x).trim()!=="";});})
    .map(function(r){var o={};for(var j=0;j<head.length;j++)o[head[j]]=r[j];return o;});
  return rows.map(function(r){
    function pick(){for(var k=0;k<arguments.length;k++){var key=nk(arguments[k]);if(r[key]!=null)return r[key];}return"";}
    var d=toDate(pick("Date"));
    return {Date:pick("Date"),Asset:pick("Asset"),Repair:pick("Repair","Description"),
      Total:numUSD(pick("Total","Total Amount","Amount")),PaidBy:pick("PaidBy","Paid By"),
      ReportedBy:pick("ReportedBy","Reporter"),_date:d};
  }).filter(function(x){return x._date;});
}

// IO
function fetchCSV(){var url=CSV_URL+"&v="+Date.now();return fetch(url,{cache:"no-store"}).then(function(r){return r.text().then(function(t){return{ok:r.ok,status:r.status,txt:t};});});}

// RENDER
function animateNumber(el, to){ var from=0, dur=500, t0=performance.now();
  function step(t){var p=Math.min(1,(t-t0)/dur);var v=from+(to-from)*p; el.textContent=(typeof to==="number")?v.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2}):v.toLocaleString(); if(p<1) requestAnimationFrame(step); }
  if(typeof to==="number") from=0; else from=0; requestAnimationFrame(step);
}
function kpis(){
  var now=new Date(), ms=new Date(now.getFullYear(),now.getMonth(),1), ws=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7);
  var m=0,w=0; rows.forEach(function(r){ if(r._date>=ms) m+=r.Total; if(r._date>=ws) w+=r.Total; });
  $("#kpi-total").textContent=rows.length.toLocaleString();
  $("#kpi-month").textContent=money(m); $("#kpi-week").textContent=money(w);
  animateNumber($("#kpi-total"), rows.length);
  animateNumber($("#kpi-month"), m);
  animateNumber($("#kpi-week"), w);
}
function toDaily(rs){var m={};rs.forEach(function(r){var d=r._date.toISOString().slice(0,10);m[d]=(m[d]||0)+r.Total;});
  var labels=Object.keys(m).sort();return{labels:labels,data:labels.map(function(l){return m[l];})};}
function chart(){
  var svg=$("#chart"); svg.innerHTML="";
  var s=toDaily(rows); if(!s.labels.length) return;
  var W=1000,H=280,P=28,max=Math.max.apply(null,s.data.concat(10));
  var pts=s.data.map(function(y,i){var x=P+i*((W-2*P)/((s.data.length-1)||1)), yy=H-P-(y/max)*(H-2*P); return [x,yy];});
  var grid=""; for(var i=0;i<5;i++){var y=P+i*((H-2*P)/4); grid+=`<line x1="${P}" y1="${y}" x2="${W-P}" y2="${y}" stroke="rgba(255,255,255,.06)"/>`; }
  svg.insertAdjacentHTML("beforeend", grid);
  var d="M"+pts.map(function(p){return p.join(",");}).join(" L ");
  var area=d+" L "+(W-P)+","+(H-P)+" L "+P+","+(H-P)+" Z";
  var areaEl=document.createElementNS("http://www.w3.org/2000/svg","path");
  areaEl.setAttribute("d",area); areaEl.setAttribute("fill","rgba(255,59,48,.22)"); areaEl.style.opacity="0";
  svg.appendChild(areaEl);
  var lineEl=document.createElementNS("http://www.w3.org/2000/svg","path");
  lineEl.setAttribute("d",d); lineEl.setAttribute("fill","none"); lineEl.setAttribute("stroke","#ff3b30"); lineEl.setAttribute("stroke-width","2");
  lineEl.style.filter="drop-shadow(0 6px 14px rgba(255,59,48,.15))";
  svg.appendChild(lineEl);
  var len=lineEl.getTotalLength(); lineEl.style.strokeDasharray=len; lineEl.style.strokeDashoffset=len;
  lineEl.getBoundingClientRect(); // reflow
  lineEl.style.transition="stroke-dashoffset .9s cubic-bezier(.22,1,.36,1)"; lineEl.style.strokeDashoffset="0";
  requestAnimationFrame(function(){ areaEl.style.transition="opacity .8s ease"; areaEl.style.opacity="1"; });
}
function table(){
  var tb=$("#tbl tbody"); tb.innerHTML="";
  rows.slice().sort(function(a,b){return b._date-a._date;}).forEach(function(r){
    var tr=document.createElement("tr"); tr.className="fadein";
    tr.innerHTML='<td>'+r._date.toLocaleDateString()+'</td><td>'+(r.Asset||'')+'</td><td>'+(r.Repair||'')+'</td>'+
      '<td class="right">'+money(r.Total)+'</td><td>'+(r.PaidBy||'')+'</td><td>'+(r.ReportedBy||'')+'</td>';
    tb.appendChild(tr);
  });
}

// FILTERS
function applyFilters(){
  var seg=document.querySelector("#rangeSeg .active"); var range=seg?seg.getAttribute("data-range"):"30";
  var q=($("#q").value||"").trim().toLowerCase(); var from=new Date(); from.setDate(from.getDate()-(range==="7"?7:30));
  rows=all.filter(function(r){
    if(r._date<from) return false; if(!q) return true;
    var ds=r._date.toLocaleDateString().toLowerCase(); var amtStr=money(r.Total).toLowerCase(), amtNum=String(r.Total);
    return String(r.Asset||"").toLowerCase().indexOf(q)>-1 || String(r.Repair||"").toLowerCase().indexOf(q)>-1 ||
           ds.indexOf(q)>-1 || amtStr.indexOf(q)>-1 || amtNum.indexOf(q)>-1;
  });
}

// FLOW
function showError(msg,sample){var e=$("#error");e.style.display="block";e.textContent=msg+(sample?("\n\nSample:\n"+sample):"");}
function hideError(){var e=$("#error");e.style.display="none";e.textContent="";}
function loadOnce(force){
  setStatus(force?"refresh…":"load…"); hideError();
  fetchCSV().then(function(res){
    if(!res.ok){showError("HTTP "+res.status,res.txt.slice(0,200));setStatus("error");return;}
    if(/^\s*</.test(res.txt)){showError("Sheet is not public",res.txt.slice(0,200));setStatus("error");return;}
    lastSig=hash(res.txt); all=parseCSV(res.txt); applyFilters(); kpis(); chart(); table(); setStatus("rows "+all.length);
  }).catch(function(err){showError(String(err));setStatus("error");});
}
function watch(){ fetchCSV().then(function(res){
    if(!res.ok) return; var sig=hash(res.txt);
    if(lastSig && sig!==lastSig){ lastSig=sig; all=parseCSV(res.txt); applyFilters(); kpis(); chart(); table(); setStatus("updated "+new Date().toLocaleTimeString()); }
  }).finally(function(){ setTimeout(watch,WATCH_MS); }); }

// UI
$("#refresh").addEventListener("click",function(){loadOnce(true);});
$("#rangeSeg").addEventListener("click",function(e){
  var b=e.target.closest("button"); if(!b) return;
  document.querySelectorAll("#rangeSeg button").forEach(function(x){x.classList.remove("active");});
  b.classList.add("active"); applyFilters(); kpis(); chart(); table();
});
$("#q").addEventListener("input",function(){applyFilters(); kpis(); chart(); table();});

// START
document.addEventListener("DOMContentLoaded",function(){ loadOnce(true); watch(); });
</script>
</body></html>
