<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet</title>
<style>
:root{--bg:#000;--fg:#e6e7ea;--muted:#9aa0a6;--ring:#1b1d22;--tile:#0b0d12;--tile2:#0f1217;--accent:#ff3b30}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;min-height:100vh;background:#000;color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto}
.wrap{padding:24px clamp(16px,4vw,48px)}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.brand{font-weight:600;font-size:18px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.seg{display:flex;gap:6px;padding:4px;border:1px solid var(--ring);border-radius:12px;background:var(--tile)}
.seg button{border:0;background:transparent;color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
.seg button.active{background:var(--tile2);color:#fff}
input,button{appearance:none;border:1px solid var(--ring);background:var(--tile);color:#e6e8ef;border-radius:12px;padding:8px 12px;font-weight:600}
button.accent{border-color:#3a1614;background:#160808;color:#ffcdc9}
.pill{font-size:12px;color:var(--muted)}
.grid{display:grid;gap:14px}.kpis{grid-template-columns:repeat(3,minmax(0,1fr))}
@media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.kpis{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--ring);border-radius:16px;padding:14px}
.kv{font-size:26px;font-weight:600;margin-top:6px}
svg{width:100%;height:260px;background:linear-gradient(180deg,#0b0e13,#000);border:1px solid var(--ring);border-radius:16px}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th,td{text-align:left;padding:12px 14px}th{font-size:12px;color:var(--muted)}
tr{background:linear-gradient(180deg,#0d1015,#0a0d12);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
a{color:var(--accent);text-decoration:none}
.right{text-align:right}
.err{background:#160808;border:1px solid #3a1614;color:#ffcdc9;border-radius:10px;padding:10px 12px;margin:10px 0;white-space:pre-wrap;display:none}
</style>
</head><body>
<div class="wrap">
  <header>
    <div class="brand">US Team Fleet</div>
    <div class="controls">
      <div class="seg" id="rangeSeg"><button data-range="7">7d</button><button data-range="30" class="active">30d</button></div>
      <input id="q" placeholder="Filter: amount, date, asset, repair"/>
      <button id="refresh" class="accent">Refresh</button>
      <span class="pill" id="status">boot…</span>
    </div>
  </header>

  <section class="grid kpis">
    <div class="card"><div class="pill">Entries</div><div id="kpi-total" class="kv">—</div></div>
    <div class="card"><div class="pill">Spend this month</div><div id="kpi-month" class="kv">—</div></div>
    <div class="card"><div class="pill">Spend last 7 days</div><div id="kpi-week" class="kv">—</div></div>
  </section>

  <section class="grid" style="margin-top:14px">
    <div class="card"><svg id="chart" viewBox="0 0 1000 260" preserveAspectRatio="none"></svg></div>
    <div class="card">
      <div class="pill" style="margin-bottom:8px">Latest entries</div>
      <div id="error" class="err"></div>
      <div style="overflow:auto">
        <table id="tbl"><thead><tr>
          <th>Date</th><th>Asset</th><th>Repair</th><th class="right">Total</th><th>PaidBy</th><th>ReportedBy</th><th>Invoice</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</div>

<script>
"use strict";

// ---- CONFIG
var SHEET_ID="1yJIieOP9u4LAj1tizjOKtzGoHcTQwTVslj5fQ3nGMKA";
var GID="2027199769";
var CSV_URL="https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/export?format=csv&gid="+GID;
var WATCH_MS=20000;

// ---- STATE
var lastSig=null, all=[], rows=[];

// ---- UTILS
function $(s){return document.querySelector(s);}
function setStatus(t){var el=$("#status"); if(el) el.textContent=t;}
function money(n){return isNaN(n)?"—":Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});}
function nk(k){return String(k||"").toLowerCase().replace(/[\uFEFF\s_-]+/g,"").replace(/[^a-z0-9]/g,"");}
function toDate(s){
  if(!s) return null; var t=String(s).replace(/\uFEFF/g,"").trim(), m;
  m=/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/.exec(t); if(m) return new Date((+m[3]<100?2000+ +m[3]:+m[3]),+m[1]-1,+m[2]);
  m=/(\d{4})-(\d{2})-(\d{2})/.exec(t); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  var d=new Date(t); return isNaN(d)?null:d;
}
function numUSD(s){ if(s==null) return 0; var m=String(s).replace(/,/g,"").match(/-?\d+(\.\d+)?/); return m?Number(m[0]):0; }
function hash(s){ var h=0; for(var i=0;i<s.length;i++) h=((h<<5)-h+s.charCodeAt(i))|0; return (h>>>0).toString(16); }

// Robust CSV parser (quotes, commas)
function parseCSV(txt){
  var out=[], row=[], val="", i=0, q=false;
  function push(){ row.push(val); val=""; }
  function endRow(){ out.push(row); row=[]; }
  for(i=0;i<txt.length;i++){
    var c=txt[i];
    if(q){
      if(c=='"' && txt[i+1]=='"'){ val+='"'; i++; }
      else if(c=='"'){ q=false; }
      else { val+=c; }
    }else{
      if(c=='"'){ q=true; }
      else if(c==','){ push(); }
      else if(c=='\n'){ push(); endRow(); }
      else if(c=='\r'){ /* ignore */ }
      else { val+=c; }
    }
  }
  push(); if(row.length) endRow();
  // header map
  if(!out.length) return [];
  var head=out[0].map(function(h){return nk(h);});
  var rows=out.slice(1).filter(r=>r.some(x=>String(x).trim()!=="")).map(function(r){
    var obj={}; for(var j=0;j<head.length;j++){ obj[head[j]]=r[j]; } return obj;
  });
  return rows.map(function(r){
    function pick(){ for(var k=0;k<arguments.length;k++){ var key=nk(arguments[k]); if(r[key]!=null) return r[key]; } return ""; }
    var d=toDate(pick("Date"));
    return { Date: pick("Date"),
      Asset: pick("Asset"),
      Repair: pick("Repair","Description"),
      Total: numUSD(pick("Total","Total Amount","Amount")),
      PaidBy: pick("PaidBy","Paid By"),
      ReportedBy: pick("ReportedBy","Reporter"),
      InvoiceLink: (function(){
        var vals=Object.values(r); for(var z=0;z<vals.length;z++){ var m=String(vals[z]||"").match(/https?:\/\/[^\s,"]+/i); if(m) return m[0]; }
        return "";
      })(),
      _date: d
    };
  }).filter(x=>x._date);
}

// ---- IO
function fetchCSV(){
  var url=CSV_URL+"&v="+Date.now();
  return fetch(url,{cache:"no-store"}).then(r=>r.text().then(t=>({ok:r.ok,status:r.status,txt:t})));
}

// ---- RENDER
function kpis(){
  var now=new Date(), ms=new Date(now.getFullYear(),now.getMonth(),1), ws=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7);
  var m=0,w=0; rows.forEach(r=>{ if(r._date>=ms) m+=r.Total; if(r._date>=ws) w+=r.Total; });
  $("#kpi-total").textContent=rows.length.toLocaleString();
  $("#kpi-month").textContent=money(m);
  $("#kpi-week").textContent=money(w);
}
function toDaily(rs){
  var m={}; rs.forEach(r=>{ var d=r._date.toISOString().slice(0,10); m[d]=(m[d]||0)+r.Total; });
  var labels=Object.keys(m).sort(); return {labels, data:labels.map(l=>m[l])};
}
function chart(){
  var svg=$("#chart"); svg.innerHTML="";
  var s=toDaily(rows); if(!s.labels.length){return;}
  var W=1000,H=260,P=28;
  var max=Math.max.apply(null,s.data.concat(10));
  var pts=s.data.map((y,i)=>[P+i*( (W-2*P)/(s.data.length-1||1) ), H-P-(y/max)*(H-2*P)]);
  // grid
  var grid=""; for(var i=0;i<5;i++){ var y=P+i*( (H-2*P)/4 ); grid+=`<line x1="${P}" y1="${y}" x2="${W-P}" y2="${y}" stroke="rgba(255,255,255,.06)"/>`; }
  svg.insertAdjacentHTML("beforeend", grid);
  // area + line
  var d="M"+pts.map(p=>p.join(",")).join(" L ");
  var area=d+" L "+(W-P)+","+(H-P)+" L "+P+","+(H-P)+" Z";
  svg.insertAdjacentHTML("beforeend", `<path d="${area}" fill="rgba(255,59,48,.22)"></path>`);
  svg.insertAdjacentHTML("beforeend", `<path d="${d}" fill="none" stroke="#ff3b30" stroke-width="2"></path>`);
}
function table(){
  var tb=$("#tbl tbody"); tb.innerHTML="";
  rows.slice().sort((a,b)=>b._date-a._date).forEach(r=>{
    var tr=document.createElement("tr");
    var link=r.InvoiceLink?`<a href="${r.InvoiceLink}" target="_blank" rel="noopener">open</a>`:"";
    tr.innerHTML=`<td>${r._date.toLocaleDateString()}</td><td>${r.Asset||""}</td><td>${r.Repair||""}</td>
      <td class="right">${money(r.Total)}</td><td>${r.PaidBy||""}</td><td>${r.ReportedBy||""}</td><td>${link}</td>`;
    tb.appendChild(tr);
  });
}

// ---- FILTERS
function applyFilters(){
  var seg=document.querySelector("#rangeSeg .active");
  var range=seg?seg.getAttribute("data-range"):"30";
  var q=($("#q").value||"").trim().toLowerCase();
  var from=new Date(); from.setDate(from.getDate()-(range==="7"?7:30));
  rows=all.filter(r=>{
    if(r._date<from) return false;
    if(!q) return true;
    var ds=r._date.toLocaleDateString().toLowerCase();
    var amtStr=money(r.Total).toLowerCase(), amtNum=String(r.Total);
    return String(r.Asset||"").toLowerCase().includes(q) ||
           String(r.Repair||"").toLowerCase().includes(q) ||
           ds.includes(q) || amtStr.includes(q) || amtNum.includes(q);
  });
}

// ---- FLOW
function loadOnce(force){
  setStatus(force?"refresh…":"load…"); hideError();
  fetchCSV().then(res=>{
    if(!res.ok){ showError("HTTP "+res.status,res.txt.slice(0,200)); setStatus("error"); return; }
    if(/^\s*</.test(res.txt)){ showError("Sheet is not public",res.txt.slice(0,200)); setStatus("error"); return; }
    lastSig=hash(res.txt); all=parseCSV(res.txt); applyFilters(); kpis(); chart(); table(); setStatus("rows "+all.length);
  }).catch(err=>{ showError(String(err)); setStatus("error"); });
}
function watch(){
  fetchCSV().then(res=>{
    if(!res.ok) return;
    var sig=hash(res.txt);
    if(lastSig && sig!==lastSig){ lastSig=sig; all=parseCSV(res.txt); applyFilters(); kpis(); chart(); table(); setStatus("updated "+new Date().toLocaleTimeString()); }
  }).finally(()=>setTimeout(watch,WATCH_MS));
}

// ---- UI
function showError(msg,sample){ var e=$("#error"); e.style.display="block"; e.textContent=msg+(sample?("\n\nSample:\n"+sample):""); }
function hideError(){ var e=$("#error"); e.style.display="none"; e.textContent=""; }
$("#refresh").addEventListener("click",()=>loadOnce(true));
$("#rangeSeg").addEventListener("click",e=>{
  var b=e.target.closest("button"); if(!b) return;
  document.querySelectorAll("#rangeSeg button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active"); applyFilters(); kpis(); chart(); table();
});
$("#q").addEventListener("input",()=>{applyFilters(); kpis(); chart(); table();});

// ---- START
document.addEventListener("DOMContentLoaded",function(){
  loadOnce(true); watch();
});
</script>
</body></html>
