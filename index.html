<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#000;--fg:#e8e8ea;--muted:#9aa0a6;--ring:#1f2228;--btn:#0f1217;--btn2:#14171d;--accent:#ff3b30}
*{box-sizing:border-box}html,body{height:100%}
body{min-height:100vh;margin:0;background:#000;color:var(--fg);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{width:100%;padding:24px 36px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.brand{font-weight:600;letter-spacing:.2px;font-size:18px}
.row{display:grid;gap:14px}.row.kpi{grid-template-columns:repeat(3,minmax(0,1fr))}
@media (max-width:980px){.row.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.row.kpi{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--ring);border-radius:16px;padding:14px}
.kpi .value{font-size:26px;font-weight:600;margin-top:8px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.seg{display:flex;border:1px solid var(--ring);border-radius:12px;padding:4px;gap:4px;background:var(--btn)}
.seg button{border:0;background:transparent;color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
.seg button.active{background:var(--btn2);color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
input,button{appearance:none;border:1px solid var(--ring);background:var(--btn);color:#e6e8ef;border-radius:12px;padding:8px 12px;font-weight:600;outline:none}
button:hover{box-shadow:0 6px 16px rgba(0,0,0,.35)}.pill{font-size:12px;color:var(--muted)}
canvas{background:linear-gradient(180deg,#0b0e13,#000);border:1px solid var(--ring);border-radius:16px;padding:8px}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th,td{text-align:left;padding:12px 14px}th{font-size:12px;color:var(--muted);font-weight:600}
tr{background:linear-gradient(180deg,#0d1015,#0a0d12);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
a{color:var(--accent);text-decoration:none}a:hover{opacity:.9}.right{text-align:right}.accent{color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">US Team Fleet</div>
    <div class="controls">
      <div class="seg" id="rangeSeg">
        <button data-range="7">7d</button>
        <button data-range="30" class="active">30d</button>
      </div>
      <input id="assetSearch" placeholder="Filter by amount, date, asset, repair"/>
      <button id="refreshBtn" class="accent" style="border-color:#3a1614;background:#160808">Refresh</button>
      <div class="pill" id="status">Boot…</div>
    </div>
  </header>

  <section class="row kpi">
    <div class="card kpi"><div class="muted">Entries</div><div class="value" id="kpi-total">—</div></div>
    <div class="card kpi"><div class="muted">Spend this month</div><div class="value accent" id="kpi-month">—</div></div>
    <div class="card kpi"><div class="muted">Spend last 7 days</div><div class="value" id="kpi-week">—</div></div>
  </section>

  <section style="display:grid;gap:14px;margin-top:14px">
    <div style="height:260px"><canvas id="chartTrend"></canvas></div>
    <div class="card">
      <div class="muted" style="margin-bottom:8px">Latest entries</div>
      <div style="overflow:auto">
        <table id="table"><thead><tr>
          <th style="min-width:110px">Date</th>
          <th style="min-width:180px">Asset</th>
          <th>Repair</th>
          <th class="right" style="min-width:110px">Total</th>
          <th style="min-width:110px">PaidBy</th>
          <th style="min-width:120px">ReportedBy</th>
          <th style="min-width:160px">Invoice Link</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</div>

<script>
"use strict";

// CONFIG
const CSV_URL="https://docs.google.com/spreadsheets/d/1yJIieOP9u4LAj1tizjOKtzGoHcTQwTVslj5fQ3nGMKA/gviz/tq?tqx=out:csv&sheet=TMS";
const FULL_REFRESH_MS=5*60*1000, CHANGE_WATCH_MS=30000;

// STATE
let lastSig=null, rowsCache=[], busy=false, rowsAll=[], rows=[], trendChart;

// UTIL
const normKey=k=>String(k||"").toLowerCase().replace(/[\uFEFF\s_-]+/g,"").replace(/[^a-z0-9]/g,"");
const money=n=>isNaN(n)?"—":Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
function numUSD(s){ if(s==null)return 0; const m=String(s).replace(/\uFEFF/g,"").replace(/,/g,"").match(/-?\d+(\.\d+)?/); return m?Number(m[0]):0; }
function toDate(s){
  if(!s) return null; const t=String(s).replace(/\uFEFF/g,"").trim();
  let m=/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/.exec(t); if(m) return new Date((+m[3]<100?2000+ +m[3]:+m[3]),+m[1]-1,+m[2]);
  m=/(\d{4})-(\d{2})-(\d{2})/.exec(t); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  const d=new Date(t); return isNaN(d)?null:d;
}
const byDateDesc=(a,b)=>((b._date?b._date.getTime():0)-(a._date?a._date.getTime():0));
const strHash=s=>{let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h+s.charCodeAt(i))|0; return (h>>>0).toString(16);};
const normalizeLink=s=>!s?"":(/^https?:\/\//i.test(String(s).trim())?String(s).trim():"");

// IO
async function downloadCSVText(){
  const r=await fetch(CSV_URL+"&v="+Date.now(),{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  const txt=await r.text();
  if(/^\s*</.test(txt)) throw new Error("HTML instead of CSV");
  return txt;
}

// PARSE
function pickField(row,variants){
  const map={}; for(const k of Object.keys(row||{})) map[normKey(k)]=k;
  for(const v of variants){
    const nk=normKey(v);
    if(map[nk]!==undefined) return row[map[nk]];
    for(const k in map){ if(k.includes(nk)||nk.includes(k)) return row[map[k]]; }
  }
  return undefined;
}
function parseRows(txt){
  const parsed=Papa.parse(txt,{header:true,dynamicTyping:false,skipEmptyLines:true});
  const data=(parsed.data||[]).filter(x=>x&&Object.keys(x).length);
  return data.map(r=>{
    const d=toDate(pickField(r,["Date"]));
    return {
      Date: pickField(r,["Date"]),
      Asset: pickField(r,["Asset"]),
      Repair: pickField(r,["Repair","Description"]),
      Total: numUSD(pickField(r,["Total Amount","Total","Amount"])),
      PaidBy: pickField(r,["PaidBy","Paid By"]),
      ReportedBy: pickField(r,["ReportedBy","Reporter"]),
      InvoiceLink: normalizeLink(pickField(r,["InvoiceLink","Invoice","Link"])),
      Comments: pickField(r,["Comments","Notes"]),
      _date: d
    };
  }).filter(r=>r._date);
}

// RENDER
function renderKPIs(){
  const now=new Date(), ms=new Date(now.getFullYear(),now.getMonth(),1), ws=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7);
  let month=0, week=0; for(const r of rows){ if(r._date>=ms) month+=r.Total; if(r._date>=ws) week+=r.Total; }
  document.getElementById("kpi-total").textContent=rows.length.toLocaleString();
  document.getElementById("kpi-month").textContent=money(month);
  document.getElementById("kpi-week").textContent=money(week);
}
function toDaily(rs){ const m={}; for(const r of rs){ const d=r._date.toISOString().slice(0,10); m[d]=(m[d]||0)+r.Total; }
  const labels=Object.keys(m).sort(); return {labels, data:labels.map(l=>m[l])}; }
function renderChart(){
  const ctx=document.getElementById("chartTrend").getContext("2d");
  if(trendChart) try{trendChart.destroy();}catch(e){}
  const s=toDaily(rows), gradLine=ctx.createLinearGradient(0,0,220,0); gradLine.addColorStop(0,"#ff3b30"); gradLine.addColorStop(1,"#b5140b");
  const gradFill=ctx.createLinearGradient(0,0,0,240); gradFill.addColorStop(0,"rgba(255,59,48,.22)"); gradFill.addColorStop(1,"rgba(255,255,255,0)");
  trendChart=new Chart(ctx,{type:"line",data:{labels:s.labels,datasets:[{data:s.data,fill:true,tension:.35,borderWidth:2,borderColor:gradLine,backgroundColor:gradFill}]},
    options:{responsive:true,maintainAspectRatio:false,animation:{duration:800},
      plugins:{legend:{display:false},tooltip:{backgroundColor:"rgba(15,18,25,.9)",borderColor:"#1f2330",borderWidth:1,padding:12,cornerRadius:10,
        callbacks:{label:c=>"$"+Number(c.parsed.y).toLocaleString()}}},
      scales:{x:{ticks:{color:"#9aa0a6"},grid:{display:false}},y:{ticks:{color:"#9aa0a6",callback:v=>"$"+v.toLocaleString()},grid:{color:"rgba(255,255,255,.06)"}}}});
}
function getRange(){ const a=document.querySelector("#rangeSeg .active"); return a?a.getAttribute("data-range"):"30"; }
function applyFilters(){
  const rv=getRange(), q=(document.getElementById("assetSearch").value||"").trim().toLowerCase();
  const now=new Date(), from=new Date(now.getFullYear(),now.getMonth(),now.getDate()-(rv==="7"?7:30));
  function match(r){
    if(!q) return true;
    const a=String(r.Asset||"").toLowerCase(), rep=String(r.Repair||"").toLowerCase(), ds=r._date.toLocaleDateString().toLowerCase();
    const amtStr=money(r.Total).toLowerCase(), amtNum=String(r.Total);
    return a.includes(q)||rep.includes(q)||ds.includes(q)||amtStr.includes(q)||amtNum.includes(q);
  }
  rows=rowsAll.filter(r=>r._date>=from&&match(r));
}
function renderTable(){
  const tb=document.querySelector("#table tbody"); tb.innerHTML="";
  for(const r of rows.slice().sort(byDateDesc)){
    const tr=document.createElement("tr");
    const link=r.InvoiceLink?`<a href="${r.InvoiceLink}" target="_blank" rel="noopener">open</a>`:"";
    tr.innerHTML=`<td>${r._date.toLocaleDateString()}</td><td>${r.Asset||""}</td><td>${r.Repair||""}</td>
      <td class="right">${money(r.Total)}</td><td>${r.PaidBy||""}</td><td>${r.ReportedBy||""}</td><td>${link}</td>`;
    tb.appendChild(tr);
  }
}

// FLOW
function setStatus(t){ const st=document.getElementById("status"); if(st) st.textContent=t; }
async function refreshAll(force){
  if(busy) return; busy=true; setStatus(force?"Refreshing…":"Loading…");
  try{
    const txt=await downloadCSVText(); const sig=strHash(txt);
    if(force||lastSig!==sig){
      lastSig=sig; const parsed=parseRows(txt); if(parsed.length) rowsAll=rowsCache=parsed;
      applyFilters(); renderKPIs(); renderChart(); renderTable();
      setStatus("Updated "+new Date().toLocaleTimeString()+" • rows "+rowsAll.length);
    }else setStatus("No changes "+new Date().toLocaleTimeString());
  }catch(e){
    console.error("refresh error:",e);
    if(rowsCache.length){ rowsAll=rowsCache; applyFilters(); renderKPIs(); renderChart(); renderTable(); setStatus("Offline • showing last data"); }
    else setStatus("Error: "+(e&&e.message?e.message:"load failed"));
  }finally{ busy=false; }
}
function watchChanges(){
  downloadCSVText().then(t=>{ const s=strHash(t); if(lastSig&&s!==lastSig) refreshAll(true); })
    .catch(()=>{}).finally(()=>setTimeout(watchChanges,CHANGE_WATCH_MS));
}

// EVENTS
document.getElementById("refreshBtn").addEventListener("click",()=>refreshAll(true));
document.getElementById("rangeSeg").addEventListener("click",e=>{
  const b=e.target.closest("button"); if(!b) return;
  document.querySelectorAll("#rangeSeg button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active"); applyFilters(); renderKPIs(); renderChart(); renderTable();
});
document.getElementById("assetSearch").addEventListener("input",()=>{applyFilters(); renderKPIs(); renderChart(); renderTable();});
document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible") refreshAll(true); });

window.addEventListener("DOMContentLoaded",function boot(i=0){
  if(window.Papa&&window.Chart){ refreshAll(true); setInterval(()=>refreshAll(true),FULL_REFRESH_MS); setTimeout(watchChanges,CHANGE_WATCH_MS); }
  else if(i<60){ setStatus("Boot… "+i); setTimeout(()=>boot(i+1),250); }
  else setStatus("Error: libs not loaded");
});
</script>
</body>
</html>
