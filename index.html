<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet • Safe</title>
<script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{--bg:#000;--fg:#e8e8ea;--muted:#9aa0a6;--ring:#1f2228;--accent:#ff3b30}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;min-height:100vh;background:#000;color:var(--fg);font:14px/1.5 system-ui,Inter,Segoe UI,Roboto}
.wrap{padding:20px 24px}
h1{margin:0 0 12px;font-size:18px}
.controls{display:flex;gap:10px;align-items:center;margin:8px 0 16px}
input,button{background:#0f1217;border:1px solid var(--ring);color:#e8e8ea;border-radius:10px;padding:8px 12px;font-weight:600}
.status{font-size:12px;color:var(--muted)}
.err{background:#160808;border:1px solid #3a1614;color:#ffcdc9;border-radius:10px;padding:10px 12px;margin:10px 0;white-space:pre-wrap}
table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
th,td{padding:10px 12px;text-align:left}th{color:var(--muted);font-size:12px}
tr{background:linear-gradient(180deg,#0d1015,#0a0d12);border:1px solid var(--ring);border-radius:10px;overflow:hidden}
td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
a{color:var(--accent);text-decoration:none}
</style></head><body>
<div class="wrap">
  <h1>US Team Fleet</h1>
  <div class="controls">
    <input id="q" placeholder="Фильтр: сумма, дата, asset, repair" />
    <button id="refresh">Refresh</button>
    <span class="status" id="status">boot…</span>
  </div>
  <div id="error" class="err" style="display:none"></div>
  <table id="tbl"><thead><tr>
    <th>Date</th><th>Asset</th><th>Repair</th><th>Total</th><th>PaidBy</th><th>ReportedBy</th><th>Invoice</th>
  </tr></thead><tbody></tbody></table>
</div>

<script>
"use strict";

// ТОЛЬКО ЭТОТ URL (CSV по GID). Лист должен быть "Anyone with the link: Viewer".
const CSV_URL = "https://docs.google.com/spreadsheets/d/1yJIieOP9u4LAj1tizjOKtzGoHcTQwTVslj5fQ3nGMKA/export?format=csv&gid=2027199769";
const WATCH_MS = 20000;

let lastSig=null, all=[], rows=[];

const $ = s => document.querySelector(s);
const money = n => isNaN(n) ? "—" : Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
const normKey = k => String(k||"").toLowerCase().replace(/[\uFEFF\s_-]+/g,"").replace(/[^a-z0-9]/g,"");

function toDate(s){
  if(!s) return null; const t=String(s).replace(/\uFEFF/g,"").trim();
  let m=/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/.exec(t); if(m) return new Date((+m[3]<100?2000+ +m[3]:+m[3]),+m[1]-1,+m[2]);
  m=/(\d{4})-(\d{2})-(\d{2})/.exec(t); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  const d=new Date(t); return isNaN(d)?null:d;
}
function numUSD(s){ if(s==null) return 0; const m=String(s).replace(/\uFEFF/g,"").replace(/,/g,"").match(/-?\d+(\.\d+)?/); return m?Number(m[0]):0; }
function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h+s.charCodeAt(i))|0; return (h>>>0).toString(16); }
function pick(row, names){
  const map={}; Object.keys(row||{}).forEach(k=>map[normKey(k)]=k);
  for(const n of names){ const nk=normKey(n); if(map[nk]!=null) return row[map[nk]];
    for(const k in map){ if(k.includes(nk) || nk.includes(k)) return row[map[k]]; } }
  return undefined;
}
function firstURL(obj){
  const re=/https?:\/\/[^\s,"]+/i;
  for(const v of Object.values(obj||{})){ const m=String(v||"").match(re); if(m) return m[0]; }
  return "";
}

async function fetchCSV(){
  const url = CSV_URL + "&v=" + Date.now();
  const r = await fetch(url,{cache:"no-store"});
  const txt = await r.text();
  return { ok:r.ok, txt, status:r.status };
}

function parseCSV(txt){
  const p = Papa.parse(txt,{header:true,dynamicTyping:false,skipEmptyLines:true});
  return (p.data||[]).filter(r=>r && Object.keys(r).length).map(r=>{
    const d = toDate(pick(r,["Date"]));
    return {
      Date: pick(r,["Date"]),
      Asset: pick(r,["Asset"]),
      Repair: pick(r,["Repair","Description"]),
      Total: numUSD(pick(r,["Total","Total Amount","Amount"])),
      PaidBy: pick(r,["PaidBy","Paid By"]),
      ReportedBy: pick(r,["ReportedBy","Reporter"]),
      InvoiceLink: (pick(r,["InvoiceLink","Invoice","Link"]) || firstURL(r)),
      _date: d
    };
  }).filter(r=>r._date);
}

function renderTable(){
  const tb = $("#tbl tbody"); tb.innerHTML="";
  rows.sort((a,b)=> (b._date-b._date) - (a._date-a._date)); // безопасно
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const link = r.InvoiceLink ? `<a href="${r.InvoiceLink}" target="_blank" rel="noopener">open</a>` : "";
    tr.innerHTML = `<td>${r._date.toLocaleDateString()}</td><td>${r.Asset||""}</td><td>${r.Repair||""}</td>
      <td>${money(r.Total)}</td><td>${r.PaidBy||""}</td><td>${r.ReportedBy||""}</td><td>${link}</td>`;
    tb.appendChild(tr);
  });
}

function applyFilter(){
  const q = ($("#q").value||"").trim().toLowerCase();
  const rangeBtn = document.querySelector("#rangeSeg .active");
  const days = rangeBtn ? (rangeBtn.dataset.range==="7"?7:30) : 30;
  const from=new Date(); from.setDate(from.getDate()-days);
  const match=r=>{
    if(!q) return true;
    return String(r.Asset||"").toLowerCase().includes(q) ||
           String(r.Repair||"").toLowerCase().includes(q) ||
           r._date.toLocaleDateString().toLowerCase().includes(q) ||
           String(r.Total).includes(q);
  };
  rows = all.filter(r=>r._date>=from && match(r));
}

function setStatus(t){ $("#status").textContent = t; }
function showError(msg, sample){ const e=$("#error"); e.style.display="block"; e.textContent = msg + (sample?("\n\nSample:\n"+sample):""); }
function hideError(){ const e=$("#error"); e.style.display="none"; e.textContent=""; }

async function loadOnce(force){
  setStatus(force?"refresh…":"load…"); hideError();
  try{
    const {ok, txt, status} = await fetchCSV();
    if(!ok){ showError("HTTP "+status, txt.slice(0,200)); setStatus("error"); return; }
    if(/^\s*</.test(txt)){ showError("Google вернул HTML (Sheet не публичный)", txt.slice(0,200)); setStatus("error"); return; }
    const sig = hash(txt);
    lastSig = sig;
    all = parseCSV(txt);
    applyFilter(); renderTable();
    setStatus("rows "+all.length);
  }catch(err){
    showError(String(err));
    setStatus("error");
  }
}

async function watch(){
  try{
    const {ok, txt} = await fetchCSV();
    if(!ok) return setTimeout(watch,20000);
    const sig = hash(txt);
    if(lastSig && sig!==lastSig){
      lastSig=sig; all=parseCSV(txt); applyFilter(); renderTable(); setStatus("updated "+new Date().toLocaleTimeString());
    }
  }catch(_){ }
  setTimeout(watch,20000);
}

// UI
$("#refresh").addEventListener("click", ()=>loadOnce(true));
$("#q").addEventListener("input", ()=>{applyFilter(); renderTable();});

// boot
window.addEventListener("DOMContentLoaded", ()=> loadOnce(true).then(watch));
</script>
</body></html>
