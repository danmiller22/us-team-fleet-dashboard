<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>US Team Fleet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#000;--fg:#e8e8ea;--muted:#9aa0a6;--ring:#1f2228;--btn:#0f1217;--btn2:#14171d;--accent:#ff3b30}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{min-height:100vh;margin:0;background:#000;color:var(--fg);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{width:100%;margin:0;padding:24px 36px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:600;letter-spacing:.2px;font-size:18px}
    .row{display:grid;gap:14px}
    .row.kpi{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:980px){.row.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.row.kpi{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--ring);border-radius:16px;padding:14px}
    .kpi .value{font-size:26px;font-weight:600;margin-top:8px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .seg{display:flex;border:1px solid var(--ring);border-radius:12px;padding:4px;gap:4px;background:var(--btn)}
    .seg button{border:0;background:transparent;color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .seg button.active{background:var(--btn2);color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
    input,button{appearance:none;border:1px solid var(--ring);background:var(--btn);color:#e6e8ef;border-radius:12px;padding:8px 12px;font-weight:600;outline:none}
    button:hover{box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .pill{font-size:12px;color:var(--muted)}
    canvas{background:linear-gradient(180deg,#0b0e13,#000);border:1px solid var(--ring);border-radius:16px;padding:8px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:left;padding:12px 14px}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tr{background:linear-gradient(180deg,#0d1015,#0a0d12);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
    tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    a{color:var(--accent);text-decoration:none}
    a:hover{opacity:.9}
    .right{text-align:right}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">US Team Fleet</div>
      <div class="controls">
        <div class="seg" id="rangeSeg">
          <button data-range="7">7d</button>
          <button data-range="30" class="active">30d</button>
        </div>
        <input id="assetSearch" placeholder="Filter by amount, date, asset, repair"/>
        <button id="refreshBtn" class="accent" style="border-color:#3a1614;background:#160808">Refresh</button>
        <div class="pill" id="status">—</div>
      </div>
    </header>

    <section class="row kpi">
      <div class="card kpi"><div class="muted">Entries</div><div class="value" id="kpi-total">—</div></div>
      <div class="card kpi"><div class="muted">Spend this month</div><div class="value accent" id="kpi-month">—</div></div>
      <div class="card kpi"><div class="muted">Spend last 7 days</div><div class="value" id="kpi-week">—</div></div>
    </section>

    <section style="display:grid;gap:14px;margin-top:14px">
      <div style="height:260px"><canvas id="chartTrend"></canvas></div>
      <div class="card">
        <div class="muted" style="margin-bottom:8px">Latest entries</div>
        <div style="overflow:auto">
          <table id="table">
            <thead>
              <tr>
                <th style="min-width:110px">Date</th>
                <th style="min-width:180px">Asset</th>
                <th>Repair</th>
                <th class="right" style="min-width:110px">Total</th>
                <th style="min-width:110px">PaidBy</th>
                <th style="min-width:120px">ReportedBy</th>
                <th style="min-width:160px">Invoice Link</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

<script>
const SHEET_ID = "1yJIieOP9u4LAj1tizjOKtzGoHcTQwTVslj5fQ3nGMKA";
const SHEET_NAME = "TMS";
const SHEET_GID = "2027199769";
let lastSig = null, CHANGED = true;

const NORM = k => String(k||"").toLowerCase().replace(/[\uFEFF\s_-]+/g,"").replace(/[^a-z0-9]/g,"");
function pickField(row, variants){
  const keys = Object.keys(row||{});
  const map = new Map(keys.map(k=>[NORM(k), k]));
  for(const v of variants){
    const nk = NORM(v);
    if(map.has(nk)) return row[map.get(nk)];
    for(const [nk2,orig] of map){
      if(nk2.indexOf(nk) !== -1 || nk.indexOf(nk2) !== -1) return row[orig];
    }
  }
  return undefined;
}

function csvUrls(){
  const u=[];
  if(SHEET_GID && /^\d+$/.test(SHEET_GID)) u.push(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`);
  u.push(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`);
  return u;
}
function money(n){ return isNaN(n)?"—":n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2}); }
function numUSD(s){ if(s==null) return 0; const t=String(s).match(/-?\d+(?:\.\d+)?/g); return t?Number(t.join("")):0; }
function toDate(s){
  if(!s) return null;
  const t = String(s).trim();
  let d = new Date(t);
  if(!isNaN(d)) return d;
  let m = /(\d{1,2})\/(\d{1,2})\/(\d{2,4})/.exec(t);
  if(m){ const mm=+m[1]-1,dd=+m[2],yy=+m[3]<100?2000+ +m[3]:+m[3]; return new Date(yy,mm,dd); }
  m = /(\d{4})-(\d{2})-(\d{2})/.exec(t);
  if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
  return null;
}
const byDateDesc=(a,b)=> (b._date?.getTime()||0)-(a._date?.getTime()||0);

let rowsAll=[], rows=[]; let trendChart;

function strHash(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h + s.charCodeAt(i))|0; } return (h>>>0).toString(16); }
function normalizeLink(s){ if(!s) return ""; s = String(s).trim(); if(/^https?:\/\//i.test(s)) return s; return ""; }

async function fetchRows(){
  rowsAll=[]; let ok=false, lastErr="";
  for(const base of csvUrls()){
    try{
      const url = base + (base.includes('?')?'&':'?') + 'v=' + Date.now();
      const resp = await fetch(url,{cache:'no-store'});
      const txt = await resp.text();
      if(/^\s*</.test(txt)){ lastErr="Sheet not public or wrong URL"; continue; }
      const sig = strHash(txt);
      if(lastSig && sig===lastSig){ CHANGED=false; ok=true; break; }
      lastSig=sig; CHANGED=true;
      const parsed = Papa.parse(txt,{header:true, dynamicTyping:false, skipEmptyLines:true});
      const data = (parsed.data||[]).filter(x=>x && Object.keys(x).length);
      rowsAll = data.map(r=>{
        const DateVal = pickField(r, ['Date']);
        const AssetVal = pickField(r, ['Asset']);
        const RepairVal = pickField(r, ['Repair','Description']);
        const TotalVal = pickField(r, ['Total Amount','Total','Amount']);
        const PaidByVal = pickField(r, ['PaidBy','Paid By']);
        const ReportedByVal = pickField(r, ['ReportedBy','Reporter']);
        const InvoiceLinkVal = pickField(r, ['InvoiceLink','Invoice','Link']);
        const CommentsVal = pickField(r, ['Comments','Notes']);
        const d = toDate(DateVal);
        return { Date:DateVal, Asset:AssetVal, Repair:RepairVal, Total:numUSD(TotalVal),
                 InvoiceLink: normalizeLink(InvoiceLinkVal), PaidBy:PaidByVal, Comments:CommentsVal,
                 ReportedBy:ReportedByVal, _date:d };
      }).filter(r=>r._date);
      ok=true; break;
    }catch(e){ lastErr = e?.message || "fetch error"; }
  }
  const st = document.getElementById('status');
  if(!ok){ if(st) st.textContent = "Error: " + (lastErr||"no CSV"); rowsAll=[]; CHANGED=true; }
  else { if(st) st.textContent = `Rows: ${rowsAll.length}`; }
}

function getRange(){ const b=document.querySelector('#rangeSeg .active'); return b?b.dataset.range:'30'; }
function applyFilters(){
  const rv=getRange(); const q=(document.getElementById('assetSearch').value||'').trim().toLowerCase();
  const now=new Date(); let from=new Date(now.getFullYear(),now.getMonth(),now.getDate()-(rv==='7'?7:30));
  function match(r){
    if(!q) return true;
    const a=String(r.Asset||'').toLowerCase(), rep=String(r.Repair||'').toLowerCase();
    const ds=r._date.toLocaleDateString().toLowerCase();
    const amtStr=money(r.Total).toLowerCase(), amtNum=String(r.Total);
    return a.includes(q)||rep.includes(q)||ds.includes(q)||amtStr.includes(q)||amtNum.includes(q);
  }
  rows = rowsAll.filter(r=>r._date>=from && match(r));
}

function renderKPIs(){
  const now=new Date(); const ms=new Date(now.getFullYear(),now.getMonth(),1); const ws=new Date(now.getFullYear(),now.getMonth(),now.getDate()-7);
  let month=0, week=0; for(const r of rows){ if(r._date>=ms) month+=r.Total; if(r._date>=ws) week+=r.Total; }
  document.getElementById('kpi-total').textContent = rows.length.toLocaleString();
  document.getElementById('kpi-month').textContent = money(month);
  document.getElementById('kpi-week').textContent  = money(week);
}

function toDaily(rs){ const m=new Map(); for(const r of rs){ const d=r._date.toISOString().slice(0,10); m.set(d,(m.get(d)||0)+r.Total); } const labels=[...m.keys()].sort(); return {labels, data:labels.map(k=>m.get(k))}; }
function renderChart(){
  const el=document.getElementById('chartTrend'); const ctx=el.getContext('2d');
  if(trendChart){ try{trendChart.destroy()}catch(e){} }
  const s=toDaily(rows);
  const gradLine=ctx.createLinearGradient(0,0,220,0); gradLine.addColorStop(0,'#ff3b30'); gradLine.addColorStop(1,'#b5140b');
  const gradFill=ctx.createLinearGradient(0,0,0,240); gradFill.addColorStop(0,'rgba(255,59,48,.22)'); gradFill.addColorStop(1,'rgba(255,255,255,0)');
  trendChart=new Chart(ctx,{type:'line',data:{labels:s.labels,datasets:[{data:s.data,fill:true,tension:.35,borderWidth:2,borderColor:gradLine,backgroundColor:gradFill}]},
    options:{responsive:true,maintainAspectRatio:false,animation:{duration:800},plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(15,18,25,.9)',borderColor:'#1f2330',borderWidth:1,padding:12,cornerRadius:10,callbacks:{label:c=>'$'+Number(c.parsed.y).toLocaleString()}}},
    scales:{x:{ticks:{color:'#9aa0a6'},grid:{display:false}},y:{ticks:{color:'#9aa0a6',callback:v=>'$'+v.toLocaleString()},grid:{color:'rgba(255,255,255,.06)'}}}});
}

function renderTable(){
  const tb=document.querySelector('#table tbody'); tb.innerHTML='';
  rows.slice().sort(byDateDesc).forEach(r=>{
    const tr=document.createElement('tr');
    const link = r.InvoiceLink ? `<a href="${r.InvoiceLink}" target="_blank" rel="noopener">open</a>` : '';
    tr.innerHTML = `<td>${r._date.toLocaleDateString()}</td>`+
                   `<td>${r.Asset||''}</td>`+
                   `<td>${r.Repair||''}</td>`+
                   `<td class="right">${money(r.Total)}</td>`+
                   `<td>${r.PaidBy||''}</td>`+
                   `<td>${r.ReportedBy||''}</td>`+
                   `<td>${link}</td>`;
    tb.appendChild(tr);
  });
}

async function refreshAll(){
  const st=document.getElementById('status'); if(st) st.textContent='Loading…';
  await fetchRows();
  applyFilters(); renderKPIs(); renderChart(); renderTable();
  if(st) st.textContent = 'Updated '+new Date().toLocaleTimeString();
}
async function live(){ await refreshAll(); setTimeout(live, 2000); }

document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('rangeSeg').addEventListener('click', e=>{ const b=e.target.closest('button'); if(!b) return; document.querySelectorAll('#rangeSeg button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); applyFilters(); renderKPIs(); renderChart(); renderTable(); });
document.getElementById('assetSearch').addEventListener('input', ()=>{ applyFilters(); renderKPIs(); renderChart(); renderTable(); });

window.addEventListener('DOMContentLoaded', async ()=>{
  for(let i=0;i<30 && (typeof Papa==='undefined' || typeof Chart==='undefined'); i++) await new Promise(r=>setTimeout(r,150));
  await refreshAll(); live();
});
</script>
</body>
</html>
